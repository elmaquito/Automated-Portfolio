name: 📚 Generate API Documentation

on:
  push:
    branches:
      - python-docs
      - js-docs
  workflow_dispatch:

jobs:
  generate-python-docs:
    if: github.ref == 'refs/heads/python-docs'
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Install Python dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser sphinx-autodoc-typehints
        pip install -r requirements.txt || echo "No requirements.txt found"

    - name: 📚 Generate Sphinx documentation
      run: |
        chmod +x scripts/generate-api-docs.sh
        bash scripts/generate-api-docs.sh python
        
    - name: 📝 Commit generated docs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add content/docs/python/
        
        if ! git diff --cached --exit-code; then
          git commit -m "📚 Auto-generate Python API docs $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin python-docs
          
          # Create PR to main
          gh pr create --title "📚 Update Python API Documentation" --body "Auto-generated Python documentation from docstrings" --head python-docs --base main || echo "PR may already exist"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-js-docs:
    if: github.ref == 'refs/heads/js-docs'
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 📦 Install JS dependencies
      run: |
        npm install jsdoc jsdoc-to-markdown
        npm install || echo "No package.json dependencies"

    - name: 📚 Generate JSDoc documentation
      run: |
        chmod +x scripts/generate-api-docs.sh
        bash scripts/generate-api-docs.sh javascript
        
    - name: 📝 Commit generated docs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add content/docs/javascript/
        
        if ! git diff --cached --exit-code; then
          git commit -m "📚 Auto-generate JavaScript API docs $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin js-docs
          
          # Create PR to main
          gh pr create --title "📚 Update JavaScript API Documentation" --body "Auto-generated JavaScript documentation from JSDoc comments" --head js-docs --base main || echo "PR may already exist"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}